# 4.6 セッション管理の不備

## 4.6.1 セッションハイジャックの原因と影響

第三者がセッションIDを利用して成りすますことをセッションハイジャックと呼ぶ。
第三者がセッションIDを知るための手段は以下３つ

* セッションIDの推測
* セッションIDの盗み出し
  * クッキー生成の際の属性の不備により漏洩
  * ネットワーク的にIDが盗聴される
  * クロスサイトスクリプティングなどのアプリケーションの脆弱性により漏洩
  * PHPやブラウザなどのプラットフォームの脆弱性により漏洩
  * セッションIDをURLに保持している場合はRefererヘッダから漏洩
* セッションIDの強制

### セッションハイジャックの影響

* 利用者の重要情報（個人情報、メールなど）の閲覧
* 利用者の持つ権限での操作（送金、物品購入など）
* 利用者のIによるメール、ブログなどへの投稿、設定の変更など

## 4.6.2 推測可能なセッションID

セッション管理機構を自作せず、実績のある言語やミドルウェア（PHP、Java/J２EE、ASP.NETなど）が提供するセッション管理機構を使用するべき。

### 攻撃手法と影響

以下手順で行われる。

* 対象アプリケーションからセッションIDを集める
* セッションIDの規則性の仮設を立てる
* 推測したセッションIDを対象アプリケーションで試す

### 対策

#### PHPのセッションIDのランダム性を改善する方法

PHP(PHP7.0まで)は、デフォルト設定では以下の組み合わせにMD5ハッシュ関数を通す方法でセッションIDを生成している。

* リモートIPアドレス
* 現在時刻
* 乱数（暗号論的疑似乱数生成系ではない）

php.iniの設定を追加することで安全な乱数をもとにセッションIDを生成するように改善可能。

```php
[Session]
;; entropy_file は　Windowsでは設定不要
sessyon.entropy_file = /dev/urandom
session.entropy_length = 32
```

/dev/urandomは、Linuxなど多くのUnix系OSで実装されている乱数生成器で、デバイスファイルとして使用できる。

## 4.6.3 URL埋め込みのセッションID

## 4.6.4 セッションIDの固定化





