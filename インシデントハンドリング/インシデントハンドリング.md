# **インシデントハンドリング**

* 攻撃手法を知る意義

    - 彼を知り己を知れば百戦危うからず


* サイバー攻撃の分析　6W1H

    * who:誰が攻撃するのか
    * why:なぜ攻撃するのか
    * whom：誰に攻撃するのか
    * what：攻撃で何を狙うのか
    * when：いつ攻撃するのか
    * where：どこを攻撃するのか
    * How：どのように攻撃するのか

    防御側の目線で行くと下から上。攻撃者の目線で行くと上から下

    * who

        * サイバー犯罪者
        * ハクティビスト：政治的な主張をしたい
        * 軍・諜報組織
        * 愉快犯

    * why

        * 金銭
        * 政治的な主張
        * 軍事目的
        * 自己顕示欲、好奇心

    * whom：誰を攻撃するのか

    * what：何を攻撃で狙うのか

        * 金銭：銀行口座情報、クレジットカード情報、暗号資産
        * 情報：個人情報、機密情報
        * サービス妨害：システムの改ざん、停止、破壊

    * when：いつ攻撃するのか

    * where

        * システム
        * 人（標的型攻撃メールなど）
        * 物理（セキュリティが弱い建物など）

    * How

        * マルウェア
        * 脆弱性（エクスプロイト）
        * フィッシング
        * ＤＯＳ
        * なりすましメール
        * ソーシャルエンジニアリング

* APT：Advanced Persistent Threat

    脆弱性を悪用し、複数の既存攻撃を組み合わせ執拗に攻撃する手法

* Cyber Kill Chain：標的に対してのサイバー攻撃の過程を7過程に分類

    1. 偵察(Reconnaissance)

        * メールアドレスの収集
        * SNSから個人情報を収集
        * プレスリリース、会議出席者リストの収集
        * インターネットからアクセス可能なサーバーの発見

    2. 武器化(Weaponization)：攻撃に使用するツール（マルウェア等)を作成する。通常自動作成ツールを使う。

        - マルウェアを埋め込む仕込みファイルの選択
        - 使用するバックドアの種類の選択
        - 適したC&Cサーバの動作の選択
        - ミッションIDをマルウェアに埋め込む
        - バックドアスクリプトのコンパイル


    3. 配送(Delivery)：マルウェアを送り付けるフェーズ

        - 直接webサーバにマルウェアを送る
        - 悪意のある電子メールとして送り付ける
        - USBにマルウェアを仕込む
        - ソーシャルメディアの活用
        - 水飲み場攻撃としてwebサイトを侵害する

    4. 攻撃(Exploit)：配送された攻撃に使用するツールを実行する

        - ソフトウェア、ハードウェアまたは人間の脆弱性を利用
        - ゼロデイエクスプロイトを利用
        - サーバの脆弱性を利用
        - 電子メールの添付ファイルからマルウェアが起動
        - 悪意のあるリンクをクリックさせる

    5. インストール(Installation)：永続化やバックドアにより長時間アクセスを維持する
        - Webサーバにwebシェルをインストール
        - クライアント端末にバックドアをインストール
        - サービス、自動実行キーなどの追加による永続化

    6. 遠隔操作(Command&Control)：標的環境でのリモート操作を確立する

        - C2サーバへの双方向チャンネルの開設
            * C2: command & controlのこと。
            * C2サーバー：不正なコマンドを遠隔で頻繁に送信するために利用されるサーバーのこと

        - Web、DNS、電子メールプロトコルを利用
        - 踏み台環境を利用してリモートアクセス
    
    7. 目的実行(Actions on Objects)：目的達成のための行動を実行する

        - ユーザ資格情報の収集
        - 権限昇格
        - 内部偵察
        - 横展開
        - データの窃取
        - システム破壊
        - データの改ざん、削除

* ATT&CK(アタック)
攻撃者の攻撃手法や戦術を分析・蓄積しているフレームワーク・ナレッジベース

    * https://attack.mitre.org/

    * Cyber kill chainよりも細かく分類されている

    * ナレッジ自体は独自作成ではなく各種ベンダのドキュメントを集めたものである。

* Unified Kill Chain
CyberKillChainとATT&CKを組み合わせたモデル。オランダの大学院生が提唱した。

    * 何度も何度も攻撃を試行して成功したら次へ

        * Initial Foothold
        * Network Propagation
        * Action on Objectives

    * 参考
        * https://mitigatecyber.com/the-unified-kill-chain-part-1/
        * https://mitigatecyber.com/the-unified-kill-chain-part-2/
        * https://www.unifiedkillchain.com/assets/The-Unified-Kill-Chain.pdf
        * https://www.unifiedkillchain.com/assets/The-Unified-Kill-Chain-Thesis.pdf

## セキュリティ対策機器を知る

![](/%E3%82%A4%E3%83%B3%E3%82%B7%E3%83%87%E3%83%B3%E3%83%88%E3%83%8F%E3%83%B3%E3%83%89%E3%83%AA%E3%83%B3%E3%82%B0/img/%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3%E6%A9%9F%E5%99%A8.png)

    * 内部ネットワーク：セキュリティが一番高い。インターネットから直接アクセスさせてはいけない

* Firewall
    代表的なのは、ネットワーク上に設置されるもの(CiscoやJuniperなどのネットワーク機器メーカが出している)だが、ホスト上に設置されるもの(Windows FirewallやLinuxのiptablesなどのソフトウェアもある)

    * プロトコル、送信元ＩＰアドレス、ポート番号、宛先IPアドレス、ポート番号でフィルタリングする（パケットフィルタリング型）
    * パケットフィルタリング型では、リクエストを許可するルールだけでなく、レスポンスを許可する通信のルールを別途作成する必要がある。しかし現代の多くのFirewallは、レスポンスの通信に関して、過去に通過したリクエストパケットに対応したものだけを通過させる機能（ダイナミックパケットフィルタリング）を持つものが多い。

    * Firewallはセキュリティレベルの異なる境界に設置する。

        ![](/%E3%82%A4%E3%83%B3%E3%82%B7%E3%83%87%E3%83%B3%E3%83%88%E3%83%8F%E3%83%B3%E3%83%89%E3%83%AA%E3%83%B3%E3%82%B0/img/firewall.png)



* IDS：Intrusion Detection System

    - システムやネットワーク上のイベントを監視、分析
    - 異常を検知した場合、アラートを発出する
    - 検知しても通知のみ、遮断は行わない
    - シグネチャお呼ばれる異常な状態を定義したルールに、監視する通信が当てはまった場合にアラートが発出される
    - 商用製品では、PaloAlto, Cisco FirePowerなど
    - OSSでは、Ｓｎｏｒｔ、Ｓｕｒｉｃａｔａなど

* IPS：Intrusion Prevension System

    - IPSは検知に加えて遮断も行う
    - 遮断を行うためIDSとは違いネットワークの通信経路上に設置される
    
    * 種類
        * ネットワーク型(NIDS)：ネットワークを流れる通信のヘッダやデータをチェック。一か所で複数のホストを監視可能であり、分析精度、コストが低い。
        * ホスト型(HIDS)：ホストの通信内容やログ、ファイルの中身をチェック。１ホストごとに監視を行う。分析精度、コストが高い

            * 近年はSSL/TLS等で通信が暗号化されることが多く、ネットワーク型でペイロードに対する検知ができないことも増えている。
    
    * IDS/IPSの設置場所
        * サーバーネットワーク
            - サーバーへの通信を監視
            - サーバーへのスキャンや脆弱性を狙った攻撃を監視

        * 内部ネットワーク
            - クライアントからの通信を監視
            - PCのマルウェア感染や外部への攻撃を監視
    
    * 検知手法
        * シグネチャ型：事前に定義した異常なパケットと一致したら検知
            * 最新のシグネチャに追従が必要
        * アノマリ型：事前に定義した正常なネットワークのふるまいから外れたら検知
            * 閾値を正しく設定するのが大変

* WAF：Web　Application Firewall

    Webアプリケーションやミドルウェアの脆弱性を悪用した攻撃からWebサイトを保護する。

    * FirewallとついているがIDS/IPSに近い
    * IDS/IPSは低レイヤ（ネットワークの階層で言うとL3~L7くらい）の通信内容を確認するが、WAFはWebプロトコル（HTTP)の通信内容に特価して確認する。
    * 商用製品では、F5 BIG-IP , Impervaなど
    * OSSでは、Mod Security, WebKnightなど
    * [Web Application Firewall 読本](https://www.ipa.go.jp/security/vuln/waf.html)

* proxy
    
    *セキュリティ用途で利用される機能
        * ユーザ認証
        * URLフィルタリング
        * 通信の複合
        * アクセスログの取得（容量が大きいパケットキャプチャの代わりとしても多く用いられる。HTTPでのマルウェア通信が多いため）
        * 商用製品では、Symantec Bluecoat, i-Filterなど
        * OSSでは、Squidなど

* Anti Virusの検索手法

    * パターンマッチ型：データの中身を見て検索。パターンが対応していれば検知可能
    * ヒューリスティック型：経験に基づく推測による検索。未知のマルウェアでも検知できる可能性がある。（誤検知の可能性もあり）
    * 具体的な製品例
        'https://support.virustotal.com/hc/en-us/articles/115002146809-Contributors'
        'https://metadefender.opswat.com/reports/anti-malware-market-share'

* Sandbox：外部から隔離された環境でファイルを開き、挙動により良性、悪性の判定を行う装置
    * マルウェアの中で、サンドボックスを検知される場合がある。

* UTM/NGFW(次世代型ファイアウォール)

    * UTM(Unified Threat Managiment)
        Firewallの機能にアンチウィルス/IPS/コンテンツフィルタなどの機能を追加したもの

    * NGFW
        従来型のFirewallではIPアドレスやポート番号単位で制御しているため、どのようなアプリケーションが通信を行っているかという判断はできなかった。NGFWでは各アプリケーション固有の通信情報を解析し、アプリケーションごとの通信を制御可能にしている。(Ｌ7)

    'https://businessnetwork.jp/Detail/tabid/65/artid/3203/Default.aspx'

* EDR (Endpoint Detection and Response)

    マルウェアの検知および感染後の迅速な対応が目的のエンドポイント製品

    ![](/%E3%82%A4%E3%83%B3%E3%82%B7%E3%83%87%E3%83%B3%E3%83%88%E3%83%8F%E3%83%B3%E3%83%89%E3%83%AA%E3%83%B3%E3%82%B0/img/EDR.png)

    * 商用製品としては、Windows Defender ATP, Crowd Strike, Carbon Blackなどがある

* SIEM(Security Information and Event Management)：複数のログをリアルタイムに収集、管理、可視化し、相関的に脅威を確認する

    * セキュリティ機器は単体では誤検知が多く、インシデントの分析に際しては、複数の情報を組み合わせて分析を行い、精度を高める必要がある。SIEMはそれを自動で行うことができ、検知制度を高めることができる。
    * ログを分析するために大容量のストレージが必要であり、フォーマットがバラバラであるため、正規化の作業が必要になる。
    * 代表的な製品としては、SplunkやElasticがある。

## インシデントハンドリングプロセス

* あらかじめ決めておくことが大事
* 作った手順を利用して訓練をしておくことが大事

* インシデントハンドリングのプロセス

    ![](/%E3%82%A4%E3%83%B3%E3%82%B7%E3%83%87%E3%83%B3%E3%83%88%E3%83%8F%E3%83%B3%E3%83%89%E3%83%AA%E3%83%B3%E3%82%B0/img/%E3%82%A4%E3%83%B3%E3%82%B7%E3%83%87%E3%83%B3%E3%83%88%E3%83%8F%E3%83%B3%E3%83%89%E3%83%AA%E3%83%B3%E3%82%B0%E3%83%97%E3%83%AD%E3%82%BB%E3%82%B9.png)

    * [NISTのフレームワーク](https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-61r2.pdf)

    * [日本語訳(ver1):](https://www.ipa.go.jp/files/000025341.pdf)

    * 準備

        * インシデント対応能力の確立

            * プロセス・ポリシーの準備・連絡先の整備

                * インシデントが発生した時の手順をあらかじめ決めておく

                    * 被害者の視点、ハンドラーの視点どちらも手順化しておくこと
                    * 手段は複数備えておく

            * 対応に必要なツールの整備

                * 調査用のＰＣ
                    * メモリ、ディスク容量が多いもの

                * インシデント分析用のツール
                    * フォレンジックツール
                        * FTK Imager, Autopsyなど
                    * マルウェア解析用ＶＭ
                        * FLARE VM(windows), REMnux(linux)など
                    * ログ解析ツール
                    * パケット解析ツール

                * 大容量の外付けディスク

            * 訓練

                -  正しくインシデント対応ができるように訓練
                    -  プロセス・ポリシーが正しく使えるか確認する
                    -  必要なツールが正しく使えるか確認する

                -  机上演習
                    -  インシデントが発生したシナリオでロールプレイを行う

                -  ハンズオン演習
                    -  対応で必要となるツールやテクニックに手を動かして慣れる
                    -  セキュリティベンダトレーニング
                    -  サイバーレンジ
                    -  セキュリティコンテストなど
            
            * 情報収集・分析
                * 情報収集の方法

                    -  公開情報(OSINT)
                    -  カンファレンス、勉強会での発表聴講
                    -  コミュニティ参加者との意見交換
                    -  ネットワークセンサー（ハニーポットなど）

        * インシデントの予防、検知する対策導入

            * ホストセキュリティ
                * 最新のセキュリティパッチの適用
                * 最低限の権限を付与
                    * 管理権限、root権限をユーザに与えない
                    * 必要なファイルのパーミッション
                * ホスト型Firewallの有効化
                * ホストの監査ログの取得

            * ネットワークセキュリティ

                -  許可されてないアクセスを拒否
                    -  Firewall
                    -  Proxy
                    -  Webフィルタリング
                -  ネットワークの監視    
                    -  IDS/IPS (Intrusion Detection/Prevention System)
                    -  WAF (Web Application Firewall)
                -  ネットワークログの取得
                    -  NetFlow
                    -  Full Packet Capture

            * マルウェア対策
                -  ネットワークレベル
                    -  IDS/IPS
                    -  SandBox
                -  アプリケーションサーバレベル
                    -  スパムメールフィルタ
                    -  Anti Virusによるメールスキャン
                -  ホストレベル
                    -  Anti Virus
                    -  EDR (Endpoint Detection and Response)


            * ユーザのリテラシー強化

    * 検知・分析

        * 検知

            * インシデントの前兆・兆候: Cyber killer chainのreconnaisance

                * 前兆：（precursor）：将来インシデントが発生する可能性があるイベント
                * 兆候：（indicator）：インシデントが発生した/している可能性を示すイベント

                * 脆弱性スキャンを示すWebサーバーログ
                * 組織のサーバーの脆弱性を標的とする

        * 分析

            * ネットワークとシステムの正常な挙動と比較

            * 複数のログを相関させて判断

            * インターネットに公開されている情報の使用

            * ログをフィルタして、分析するログを絞る

            * ナレッジベースの使用。（普段からナレッジを蓄積しておく）

            [] virustotalの使い方を覚えたい。

        * インシデントの記録

            * チケットシステム等を利用してインシデント管理（redmineなど）

        * 優先順位付け（トリアージ）

            * 機能的な影響：提供している機能にどれだけ影響を与えるか

            * 情報影響：扱っている情報がどのような影響を受ける/受けたかという指標

            * 復旧可能性：復旧するのにどれだけコストがかかるか 

        * 報告：ポリシーに従った報告を。

            * 世の中的に報告フェーズが重要視される傾向にある。

    * 封じ込め：被害拡大を防ぐ処置を行う

        * 封じ込め戦略の決定

            * 証拠保全

                * LANケーブル抜く前に証拠保全をすることが大事だったりする。

                    * デュプリケーター：ハードディスクを丸ごとコピーするという点がポイント。ＯＳからではない。

             * 封じ込めのアクション

    * 根絶

        * インシデント原因の特定

        * マルウェアの駆除

            * マルウェア解析から駆除スクリプトを作る
            * アンチウィルススキャン
            * クリーンインストール：最も確実

        * 脆弱性の修正

    * 復旧：システムを元の状態に戻すフェーズ

    * 対応後の活動：インシデントの振り返り








