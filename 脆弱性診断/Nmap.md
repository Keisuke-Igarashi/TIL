# Nmap

## 取得できる情報
- ポート番号
- ソフトウェア名
- ソフトウェアバージョン
- ソフトウェアの設定情報
- 脆弱性検出


## 注意点
不正アクセス禁止法に抵触するので、診断対象以外に利用しない

## コマンド
```
nmap 10.0.0.1
nmap 10.0.0.1 localhost
nmap 10.0.0.10-222
nmap 10.0.0.0/24
```

TCPコネクトスキャン
```
nmap -sT 10.0.0.1
```
3wayハンドシェイク実行され、ＴＣＰコネクションが張られるため、  
firewall,IDS,IPS等に検知されやすい。

ステルススキャン
```
nmap -sS 10.0.0.1
```
SYN AYN/ACK RST のみ秘匿性が高い。

ステルススキャン（-sF)
```
nmap -sF 10.0.0.1
```
FINフラグを送信し、何も返却されなかった場合はポートが
開いていると判断する。
https://e-words.jp/w/FIN%E3%83%91%E3%82%B1%E3%83%83%E3%83%88.html#:~:text=FIN%E3%83%91%E3%82%B1%E3%83%83%[…]1%A3%E3%81%A6%E3%81%84%E3%82%8B%E3%80%82


ポート指定
```
nmap -p1-1024 <スキャン対象のIP>
nmap -p21,8000 <スキャン対象のIP>
nmap -p21-25,80,139-445 <スキャン対象のIP>
```

UDPのポート指定
```
nmap -sU -pU:<port range> <スキャン対象のIP>
nmap -SU -sS -pT:21-25,80 U:53,157 <スキャン対象のIP>
nmap -p- <スキャン対象のIP>
# 何もつけない場合は1024ポートまでを検索する
```

OSバージョン確認
```
nmap -O <スキャン対象のIP>
```
※特定できないこともある場合に留意


-oAオプション
```
nmap -oA <filename> <スキャン対象のIP> [その他のオプション]
```

.gnmap : greppable(グレップしやすい形式)

-snオプション
pingスキャンを実施する(時短)
```
nmap -sn <スキャン対象のIP>
```

-sVオプション（サービスバージョンスキャン）
マシンで起動しているサービスのバージョンを特定する。（よく使う）
```
nmap -sV <スキャン対象のIP> <オプション>
```

-A オプション（複合スキャン）
4つのオプションを含んでいる。時間かかるし出力量大
    - -O
    - -sV
    - -sC（NSEを用いた標準的なスキャン）
    - --traceroute(対象マシンまで経路を表示)

### 検知回避オプション
スキャンをゆっくりにしたり、間隔を開けるなどの工夫をする。

- -sA
TCP ACKスキャン
- -f
パケットをフラグ
- -T0,1,2,3,4,5
スキャン間隔を変更する

- --scan-delay (ディレイスキャン)
次のスキャンまでの待機時間を設定する。長い時間をかけてスキャンするとき
```
nmap --scan-delay 100ms <対象のIP>
```

### NSE（Nmap Scripting Engine)
プラグインを記述されるためのエンジン  
よく使われるスクリプトは/usr/share/nmap/scripts  
に入っている  

```
nmap --script=default,broadcast <スキャン対象のIP>
```

|カテゴリ|概要|
----|----
|auto|認証情報や資格情報を取得|
|broadcast|ブロードキャストにより情報を取得するもの|
|brute|ブルートフォース攻撃を使用するもの|
|default|NSEスクリプトを選択せず行うスキャン|
|dos|DoS攻撃を行うもの|
|exploit|脆弱性を悪用するようなもの|
|external|サードパーティのデータベースやネットワークリソースに対してデータを送信するようなもの|
|fuzzer|各サーバーソフトウェアが予期しないものを送信するようなもの|
|intrusive|ユーザの環境に侵入しようとするもの|
|malware|マルウェアやバックドアに感染しているかをテストするもの|
|safe|サービスをクラッシュさせたりセキュリティホールを悪用したりしないもの|
|version|各サービスのバージョン検出機能を持つもの|
|vuln|既知の脆弱性チェックを行うもの|

```
nmap --script=<スクリプト名> --script-args=<スクリプト引数> <スキャン対象IP>
```

```
nmap -p 80 --script=http-vuln-cve2017-5638 --script-args path=/struts2
```

- NSEスクリプトの探し方  
名前スクリプト内にプロトコル名、関連するアプリケーション名が含まれている。

    - スクリプト名
    ```
    ls /usr/share/nmap?scripts | grep smb
    ```

    - スクリプトの中身
    ```
    grep apache -rl /usr/share/nmap/scripts/
    ```

#### NSEスクリプトハンズオン
ユーザ情報の取得
```
nmap --script=brute -p 512 <対象のIP>
```

取得したユーザー情報で
```
rsh -l user <対象ホストのIP> ls /var/www
```
※rshコマンドはリモートホスト上でコマンドを実行するコマンド

## FTP

### FTPコマンド
```
ftp <対象ホストのIP>
```

### FTP用のコマンド
|コマンド名|概要|
----|----
|ls|FTPサーバー名の一覧|
|cd|FTPサーバーのカレントディレクトリ|
|!ls|クライアント内のファイル一覧|
|lcd|クライアントのcd操作|
|get|FTPサーバーからダウンロード|
|put|FTPサーバーからファイルをアップロード|
|passive|ACTIVEモードとPASVモードを切り替える|
|bye,exit,quit|FTPサーバーからログアウト|
|help|各種コマンドの使い方一覧|

### ACTIVE vs PASV
ACTIVE：サーバから接続開始
PASV：クライアントから接続開始

※クライアントにACTIVEで接続できないことがある。  
クライアントが外からの接続を制限されていることが多いため。  

### FTPのgetコマンド
```
get <ファイル名>
```

### FTPのupコマンド
```
lcd .. #クライアントのディレクトリ移動
put <ファイル名>
```

### FTPのログ
- /var/log配下にログファイルが出力される
- vsftpd.logなど


### 脆弱性付のポート検索
```
$nmap -sV --script vuln <ipアドレス>
```

### exploitの検索
```
sf6 > search ms17-010
```

